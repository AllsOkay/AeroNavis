<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞—Ä—Ç–∞ | Aeronavis</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Main Styles -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json" />
</head>
<body>

    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="aeronavis-logo.png" alt="Aeronavis Logo" />
            </div>
            <nav>
                <ul>
                    <li><a href="map.html" class="active"><i class="fas fa-map-marked-alt"></i> –ö–∞—Ä—Ç–∞</a></li>
                    <li><a href="documentation.html"><i class="fas fa-file-alt"></i> –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</a></li>
                    <li><a href="#"><i class="fas fa-mobile-alt"></i> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</a></li>
                    <li><a href="#"><i class="fas fa-user"></i></a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã -->
    <div id="map-container">
        <div id="map"></div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –¥–∞–Ω–Ω—ã–µ -->
        <div class="details-panel" id="detailsPanel" style="display: none;">
            <div class="header">
                <h3 id="boatName">–õ–æ–¥–∫–∞ "–í–æ–¥–Ω—ã–π –ø—á—ë–ª"</h3>
                <div class="status-bar">
                    <i class="fas fa-battery-full"></i> 87% &nbsp;
                    <i class="fas fa-wifi"></i> 23ms &nbsp;
                    <i class="fas fa-hashtag"></i> #Bee01
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
            <div class="boat-controls">
                <button id="setDestination">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å</button>
                <button id="sendToBoat">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ª–æ–¥–∫—É</button>
                <div class="status" id="status">–ì–æ—Ç–æ–≤–æ</div>
            </div>

            <!-- –î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤ (–¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞) -->
            <div class="point-info" id="pointInfo" style="display: none;">
                <h4 id="pointTitle">–¢–æ—á–∫–∞ #1</h4>
                <div class="water-params">
                    <div class="param"><span>üå°Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</span> <span class="value" id="temp">22.5¬∞C</span></div>
                    <div class="param"><span>üß™ pH —É—Ä–æ–≤–µ–Ω—å</span> <span class="value" id="ph">7.2</span></div>
                    <div class="param"><span>üå´Ô∏è –ú—É—Ç–Ω–æ—Å—Ç—å –≤–æ–¥—ã</span> <span class="value" id="turbidity">15 FNU</span></div>
                    <div class="param"><span>‚ö° –≠–ª–µ–∫—Ç—Ä–æ–ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å</span> <span class="value" id="conductivity">520 –º–∫–°–º/—Å–º</span></div>
                    <div class="param"><span>üìä –û—Ü–µ–Ω–∫–∞</span> <span class="value" id="score">87 / 100</span></div>
                </div>
            </div>

            <!-- –£–¥–∞–ª–µ–Ω–æ: –ì—Ä–∞—Ñ–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ -->

            <div class="last-update">
                –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="updateTime">—Ç–æ–ª—å–∫–æ —á—Ç–æ</span>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç -->
    <script>
        let map, boatMarker, destinationMarker;
        let destinationCoords = null;
        let boatPosition = [55.7558, 37.6176]; // –ù–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –ª–æ–¥–∫–∏
        let indicatorMarkers = []; // –•—Ä–∞–Ω–∏—Ç –º–µ—Ç–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã

        // –¢–µ—Å—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—É–∂–µ –Ω–∞ –∫–∞—Ä—Ç–µ)
        const testIndicators = [
            { lat: 55.7565, lng: 37.6185, temp: 21.8, ph: 7.4, turbidity: 12, conductivity: 510, score: 88 },
            { lat: 55.7550, lng: 37.6160, temp: 23.1, ph: 7.0, turbidity: 18, conductivity: 535, score: 85 }
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        function initMap() {
            map = L.map('map').setView(boatPosition, 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19,
            }).addTo(map);

            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            addTestIndicators();

            // –°–æ–∑–¥–∞—ë–º –ª–æ–¥–∫—É –∫–∞–∫ –∑–Ω–∞—á–æ–∫
            boatMarker = L.marker(boatPosition, {
                icon: L.divIcon({
                    className: 'boat-icon',
                    html: 'üö§',
                    iconSize: [32, 32],
                    iconAnchor: [16, 16]
                })
            }).addTo(map).bindPopup("–õ–æ–¥–∫–∞ '–í–æ–¥–Ω—ã–π –ø—á—ë–ª'<br>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å").openPopup();

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –ª–æ–¥–∫—É
            boatMarker.on('click', () => {
                showControlPanel();
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ (—É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏)
            map.on('click', function(e) {
                const setBtn = document.getElementById('setDestination');
                if (setBtn.classList.contains('active')) {
                    if (destinationMarker) map.removeLayer(destinationMarker);
                    destinationCoords = e.latlng;
                    destinationMarker = L.marker(e.latlng, {
                        icon: L.divIcon({
                            className: 'target-marker',
                            html: 'üéØ',
                            iconSize: [28, 28],
                            iconAnchor: [14, 14]
                        })
                    }).addTo(map).bindPopup("–¶–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞").openPopup();

                    setBtn.classList.remove('active');
                    document.getElementById('status').textContent = `–¶–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`;
                }
            });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—Å –±—É–ª–∞–≤–∫–∞–º–∏)
function addTestIndicators() {
    testIndicators.forEach((point, i) => {
        const colorClass = getPinColor(point.score);
        const icon = L.divIcon({
            className: 'pin-circle ' + colorClass,
            html: `${point.score}`,
            iconSize: [40, 40],
            iconAnchor: [20, 40],  // –ù–∏–∑ –∏–∫–æ–Ω–∫–∏ ‚Äî –∫–∞–∫ —É –±—É–ª–∞–≤–∫–∏
            popupAnchor: [0, -40]   // –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å–≤–µ—Ä—Ö—É
        });

        const marker = L.marker([point.lat, point.lng], { icon }).addTo(map);

        marker.bindPopup(`
            <strong>–¢–æ—á–∫–∞ #${i+1}</strong><br>
            –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${point.temp}¬∞C<br>
            pH: ${point.ph}<br>
            –ú—É—Ç–Ω–æ—Å—Ç—å: ${point.turbidity} FNU<br>
            –ü—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å: ${point.conductivity} –º–∫–°–º/—Å–º<br>
            –û—Ü–µ–Ω–∫–∞: ${point.score}/100
        `);

        marker.on('click', () => {
            showIndicatorDetails(point, `–¢–æ—á–∫–∞ #${i+1}`);
        });

        indicatorMarkers.push(marker);
    });
}

        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function showControlPanel() {
            const panel = document.getElementById('detailsPanel');
            panel.style.display = 'flex';
            document.getElementById('pointInfo').style.display = 'none'; // –°–∫—Ä—ã—Ç—å –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏
            document.getElementById('status').textContent = '–ì–æ—Ç–æ–≤–æ';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        function showIndicatorDetails(point, title) {
            const panel = document.getElementById('detailsPanel');
            panel.style.display = 'flex';
            document.getElementById('pointInfo').style.display = 'block';

            document.getElementById('boatName').textContent = '–ò–∑–º–µ—Ä–µ–Ω–∏–µ –Ω–∞ —Ç–æ—á–∫–µ';
            document.getElementById('pointTitle').textContent = title;
            document.getElementById('temp').textContent = `${point.temp}¬∞C`;
            document.getElementById('ph').textContent = point.ph;
            document.getElementById('turbidity').textContent = `${point.turbidity} FNU`;
            document.getElementById('conductivity').textContent = `${point.conductivity} –º–∫–°–º/—Å–º`;
            document.getElementById('score').textContent = `${point.score} / 100`;
            document.getElementById('updateTime').textContent = '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
        }

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ü–µ–ª–∏
        document.getElementById('setDestination').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('status').textContent = "–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–∏";
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–¥–∫–∏
        document.getElementById('sendToBoat').addEventListener('click', async function() {
            if (!destinationCoords) {
                alert("–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–ª—å!");
                return;
            }

            document.getElementById('status').textContent = "‚úÖ –õ–æ–¥–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!";

            // –ò–º–∏—Ç–∞—Ü–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –ª–æ–¥–∫–∏
            setTimeout(() => {
                // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –º–∞—Ä–∫–µ—Ä –ª–æ–¥–∫–∏
                boatMarker.setLatLng(destinationCoords);
                map.panTo(destinationCoords);

                // –°–æ–∑–¥–∞—ë–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                createIndicatorAt(destinationCoords);

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–µ–ª—å
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                    destinationMarker = null;
                }
                destinationCoords = null;

                document.getElementById('status').textContent = "üéØ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã";
            }, 1500);
        });

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (—Å –±—É–ª–∞–≤–∫–æ–π)
function createIndicatorAt(coords) {
    const temp = (Math.random() * 4 + 20).toFixed(1);
    const ph = (Math.random() * 1.5 + 6.5).toFixed(1);
    const turbidity = Math.floor(Math.random() * 20 + 10);
    const conductivity = Math.floor(Math.random() * 200 + 500);
    const score = Math.floor(Math.random() * 10 + 80); // 80‚Äì90

    const colorClass = getPinColor(score);
    const icon = L.divIcon({
        className: 'pin-circle ' + colorClass,
        html: `${score}`,
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });

    const marker = L.marker([coords.lat, coords.lng], { icon }).addTo(map);

    marker.bindPopup(`
        <strong>–ù–æ–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ</strong><br>
        –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${temp}¬∞C<br>
        pH: ${ph}<br>
        –ú—É—Ç–Ω–æ—Å—Ç—å: ${turbidity} FNU<br>
        –ü—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å: ${conductivity} –º–∫–°–º/—Å–º<br>
        –û—Ü–µ–Ω–∫–∞: ${score}/100
    `);

    marker.on('click', () => {
        showIndicatorDetails({ temp, ph, turbidity, conductivity, score }, "–ù–æ–≤–∞—è —Ç–æ—á–∫–∞");
    });

    indicatorMarkers.push(marker);
}

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –±—É–ª–∞–≤–∫–∏ –ø–æ –æ—Ü–µ–Ω–∫–µ
function getPinColor(score) {
    if (score >= 80) return 'green';
    if (score >= 60) return 'yellow';
    if (score >= 40) return 'orange';
    return 'red';
}

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = initMap;

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered'))
                .catch(err => console.log('SW registration failed', err));
        }
    </script>
</body>
</html>